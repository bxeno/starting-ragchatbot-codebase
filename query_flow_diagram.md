# RAG Chatbot Query Processing Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    FRONTEND                                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  User Input                                                                             │
│  ┌─────────────┐    ┌────────────────┐    ┌─────────────────────────────────────────┐   │
│  │  Text Box   │───▶│ sendMessage()  │───▶│ fetch('/api/query', {                   │   │
│  │             │    │ (script.js:45) │    │   method: 'POST',                       │   │
│  │ "Question?" │    └────────────────┘    │   body: JSON.stringify({                │   │
│  └─────────────┘                          │     query: query,                       │   │
│                                           │     session_id: currentSessionId        │   │
│                                           │   })                                    │   │
│                                           │ })                                      │   │
│                                           └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────┼───────────────────────────────────────────┘
                                              │ HTTP POST
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   FASTAPI LAYER                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  API Endpoint (app.py:56)                                                              │
│  ┌─────────────────────────────────────────┐    ┌─────────────────────────────────────┐ │
│  │ @app.post("/api/query")                 │    │ Session Management                  │ │
│  │ async def query_documents():            │───▶│ - Create session if needed          │ │
│  │   - Parse QueryRequest                  │    │ - Get/create session_id             │ │
│  │   - Extract query & session_id          │    └─────────────────────────────────────┘ │
│  └─────────────────────────────────────────┘                                           │
└─────────────────────────────────────────────┼───────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 RAG SYSTEM CORE                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  Query Processing (rag_system.py:102)                                                  │
│  ┌─────────────────────────────────────────┐    ┌─────────────────────────────────────┐ │
│  │ def query(query, session_id):           │    │ Session Manager                     │ │
│  │   1. Build prompt                       │───▶│ - Get conversation history          │ │
│  │   2. Get conversation history           │    │ - Maintain context                  │ │
│  │   3. Call AI generator with tools       │    └─────────────────────────────────────┘ │
│  └─────────────────────────────────────────┘                                           │
└─────────────────────────────────────────────┼───────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                AI GENERATION                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  Claude API Call (ai_generator.py:43)                                                  │
│  ┌─────────────────────────────────────────┐    ┌─────────────────────────────────────┐ │
│  │ generate_response():                    │    │ System Prompt                       │ │
│  │ - System prompt                         │◀───┤ "You are an AI assistant           │ │
│  │ - User query + history                  │    │  specialized in course materials   │ │
│  │ - Available tools                       │    │  with access to search tool..."    │ │
│  │ - Call Claude API                       │    └─────────────────────────────────────┘ │
│  └─────────────────────────────────────────┘                                           │
└─────────────────────────────────────────────┼───────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                            CLAUDE DECISION MAKING                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  Claude analyzes query and decides:                                                    │
│                                                                                         │
│  ┌─────────────────────────┐           ┌─────────────────────────┐                     │
│  │    General Knowledge    │           │   Course-Specific       │                     │
│  │       Question          │           │      Question           │                     │
│  │                         │           │                         │                     │
│  │ "What is machine        │           │ "What did the instructor│                     │
│  │  learning?"             │           │  say about neural nets  │                     │
│  │                         │           │  in lesson 2?"          │                     │
│  └───────────┬─────────────┘           └────────────┬────────────┘                     │
│              │                                      │                                  │
│              ▼                                      ▼                                  │
│  ┌─────────────────────────┐           ┌─────────────────────────┐                     │
│  │   Answer directly       │           │   Use search tool       │                     │
│  │   from knowledge        │           │                         │                     │
│  └─────────────────────────┘           └────────────┬────────────┘                     │
│                                                     │                                  │
└─────────────────────────────────────────────────────┼───────────────────────────────────┘
                                                      │
                                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              VECTOR SEARCH                                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  Search Tool Execution                                                                 │
│  ┌─────────────────────────────────────────┐    ┌─────────────────────────────────────┐ │
│  │ CourseSearchTool.search():              │    │ VectorStore (ChromaDB)              │ │
│  │ 1. Query → embeddings                   │───▶│ - Semantic similarity search        │ │
│  │ 2. Search ChromaDB                      │    │ - Retrieve top-k chunks             │ │
│  │ 3. Rank by relevance                    │    │ - Include metadata                  │ │
│  │ 4. Return context chunks                │    │   (course, lesson, chunk_index)     │ │
│  └─────────────────────────────────────────┘    └─────────────────────────────────────┘ │
│                                                                                         │
│  Document Storage Structure:                                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┤
│  │ "Course Machine Learning Lesson 2 content: Neural networks are..."                │ │
│  │ Metadata: {course_title: "ML", lesson_number: 2, chunk_index: 5}                   │ │
│  └─────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────┼───────────────────────────────────────────┘
                                              │ Retrieved Context
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           RESPONSE SYNTHESIS                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  Claude combines:                                                                      │
│  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐              │
│  │   Search Results    │+│ Conversation History│+│   AI Knowledge      │              │
│  │                     │ │                     │ │                     │              │
│  │ "Neural networks    │ │ "Previously we      │ │ "Neural networks    │              │
│  │  from lesson 2..."  │ │  discussed..."      │ │  are models..."     │              │
│  └─────────────────────┘ └─────────────────────┘ └─────────────────────┘              │
│                                     │                                                  │
│                                     ▼                                                  │
│                        ┌─────────────────────────────────┐                            │
│                        │     Synthesized Response        │                            │
│                        │                                 │                            │
│                        │ "Based on the course material,  │                            │
│                        │  neural networks are..."        │                            │
│                        └─────────────────────────────────┘                            │
└─────────────────────────────────────────────┼───────────────────────────────────────────┘
                                              │
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              RESPONSE FLOW BACK                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐        │
│  │   AI Generator      │───▶│    RAG System       │───▶│    FastAPI          │        │
│  │   Returns response  │    │    Returns          │    │    Returns JSON     │        │
│  │                     │    │    (answer, sources)│    │    QueryResponse    │        │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘        │
└─────────────────────────────────────────────┼───────────────────────────────────────────┘
                                              │ HTTP Response
                                              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND RENDERING                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  Response Processing (script.js:76-85)                                                 │
│  ┌─────────────────────────────────────────┐    ┌─────────────────────────────────────┐ │
│  │ fetch() response handling:              │    │ UI Updates                          │ │
│  │ 1. Parse JSON response                  │───▶│ - Remove loading indicator          │ │
│  │ 2. Update session_id                    │    │ - Add response message              │ │
│  │ 3. Display answer                       │    │ - Render markdown                   │ │
│  │ 4. Show sources (if any)                │    │ - Enable input field                │ │
│  └─────────────────────────────────────────┘    └─────────────────────────────────────┘ │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┤
│  │ 🤖 Assistant: Based on the course material, neural networks are computational      │ │
│  │     models inspired by biological neural networks...                               │ │
│  │                                                                                     │ │
│  │ 📚 Sources: course1_script.txt, course2_script.txt                                │ │
│  └─────────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘

Key Data Structures:
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ QueryRequest: { query: str, session_id: Optional[str] }                                 │
│ QueryResponse: { answer: str, sources: List[str], session_id: str }                     │
│ CourseChunk: { content: str, course_title: str, lesson_number: int, chunk_index: int }  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```